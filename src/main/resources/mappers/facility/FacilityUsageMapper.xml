<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gaekdam.gaekdambe.operation_service.facility.query.mapper.FacilityUsageMapper">

    <!-- =========================
         ë¶€ëŒ€ì‹œì„¤ ì´ìš©ë‚´ì—­ ì¡°íšŒ (SaaS ë‹¨ì¼ í˜¸í…”)
         ========================= -->
    <select id="findFacilityUsages"
            resultType="com.gaekdam.gaekdambe.operation_service.facility.query.dto.response.FacilityUsageResponse">

        SELECT
        fu.facility_usage_code AS facilityUsageCode,
        fu.usage_at            AS usageAt,
        fu.usage_type          AS usageType,
        fu.used_person_count   AS usedPersonCount,
        fu.usage_quantity      AS usageQuantity,
        fu.usage_price         AS usagePrice,
        fu.price_source        AS priceSource,
        fu.stay_code           AS stayCode,
        fu.facility_code       AS facilityCode
        FROM facility_usage fu
        JOIN facility f ON fu.facility_code = f.facility_code

        <where>
            <if test="search != null">

                <!-- ðŸ” SaaS í˜¸í…” ìŠ¤ì½”í”„ (í•„ìˆ˜) -->
                <if test="search.hotelGroupCode != null">
                    AND f.hotel_group_code = #{search.hotelGroupCode}
                </if>

                <if test="search.stayCode != null">
                    AND fu.stay_code = #{search.stayCode}
                </if>

                <if test="search.facilityCode != null">
                    AND fu.facility_code = #{search.facilityCode}
                </if>

                <if test="search.usageType != null and search.usageType != ''">
                    AND fu.usage_type = #{search.usageType}
                </if>

                <if test="search.priceSource != null and search.priceSource != ''">
                    AND fu.price_source = #{search.priceSource}
                </if>

                <!-- ë‚ ì§œ ì¡°ê±´ (date ìš°ì„ ) -->
                <if test="search.date != null">
                    AND DATE(fu.usage_at) = #{search.date}
                </if>

                <if test="search.date == null and search.fromDate != null">
                    AND fu.usage_at <![CDATA[ >= ]]> #{search.fromDate}
                </if>

                <if test="search.date == null and search.toDate != null">
                    AND fu.usage_at <![CDATA[ <= ]]> #{search.toDate}
                </if>

            </if>
        </where>

        <if test="sort != null and sort.sortBy != null">
            ORDER BY ${sort.sortBy} ${sort.direction}
        </if>

        LIMIT #{page.size} OFFSET #{page.offset}
    </select>

    <!-- =========================
         ì´ ê°œìˆ˜ (ë¦¬ìŠ¤íŠ¸ì™€ ì¡°ê±´ 100% ë™ì¼)
         ========================= -->
    <select id="countFacilityUsages" resultType="long">
        SELECT COUNT(*)
        FROM facility_usage fu
        JOIN facility f ON fu.facility_code = f.facility_code

        <where>
            <if test="search != null">

                <!-- SaaS í˜¸í…” ìŠ¤ì½”í”„ (í•„ìˆ˜) -->
                <if test="search.hotelGroupCode != null">
                    AND f.hotel_group_code = #{search.hotelGroupCode}
                </if>

                <if test="search.stayCode != null">
                    AND fu.stay_code = #{search.stayCode}
                </if>

                <if test="search.facilityCode != null">
                    AND fu.facility_code = #{search.facilityCode}
                </if>

                <if test="search.usageType != null and search.usageType != ''">
                    AND fu.usage_type = #{search.usageType}
                </if>

                <if test="search.priceSource != null and search.priceSource != ''">
                    AND fu.price_source = #{search.priceSource}
                </if>

                <!-- ë‚ ì§œ ì¡°ê±´ -->
                <if test="search.date != null">
                    AND DATE(fu.usage_at) = #{search.date}
                </if>

                <if test="search.date == null and search.fromDate != null">
                    AND fu.usage_at <![CDATA[ >= ]]> #{search.fromDate}
                </if>

                <if test="search.date == null and search.toDate != null">
                    AND fu.usage_at <![CDATA[ <= ]]> #{search.toDate}
                </if>

            </if>
        </where>
    </select>

</mapper>
