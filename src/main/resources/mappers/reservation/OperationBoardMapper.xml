<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gaekdam.gaekdambe.reservation_service.reservation.query.mapper.OperationBoardMapper">

    <!-- ================================================= -->
    <!-- 운영보드 조회 (LIST) -->
    <!-- ================================================= -->
    <select id="findOperationBoard"
            resultType="com.gaekdam.gaekdambe.reservation_service.reservation.query.dto.response.OperationBoardCryptoRow">

        SELECT
        t.reservationCode,
        t.customerCode,
        t.customerNameEnc,
        t.dekEnc,
        t.roomType,
        t.propertyName,
        t.plannedCheckinDate,
        t.plannedCheckoutDate,
        t.operationStatus
        FROM (
        SELECT
        r.reservation_code AS reservationCode,
        c.customer_code    AS customerCode,
        c.customer_name_enc AS customerNameEnc,
        c.customer_name_hash AS customerNameHash,
        c.dek_enc          AS dekEnc,
        rt.type_name       AS roomType,
        p.property_name    AS propertyName,
        r.checkin_date     AS plannedCheckinDate,
        r.checkout_date    AS plannedCheckoutDate,
        r.property_code    AS propertyCode,

        /* =========================
        운영보드 상태 (정합성 보장)
        ========================= */
        CASE
        -- 취소
        WHEN r.reservation_status = 'CANCELED'
        THEN 'CANCELED'

        -- 노쇼 (명시적)
        WHEN r.reservation_status = 'NO_SHOW'
        THEN 'NO_SHOW'

        -- 노쇼 (예약기간 지남 + 투숙 없음)
        WHEN r.checkout_date <![CDATA[ < ]]> CURRENT_DATE
        AND s.stay_code IS NULL
        THEN 'NO_SHOW'

        -- 예약 완료 (아직 체크인 전)
        WHEN s.stay_code IS NULL
        THEN 'RESERVED'

        -- 투숙 중
        WHEN s.actual_checkin_at IS NOT NULL
        AND s.actual_checkout_at IS NULL
        THEN 'STAYING'

        -- 정상 완료
        WHEN s.actual_checkin_at IS NOT NULL
        AND s.actual_checkout_at IS NOT NULL
        THEN 'COMPLETED'

        ELSE 'UNKNOWN'
        END AS operationStatus

        FROM reservation r
        INNER JOIN property p ON r.property_code = p.property_code
        INNER JOIN customer c ON r.customer_code = c.customer_code
        LEFT JOIN stay s ON r.reservation_code = s.reservation_code
        LEFT JOIN room ro ON r.room_code = ro.room_code
        LEFT JOIN room_type rt ON ro.room_type_code = rt.room_type_code
        WHERE p.hotel_group_code = #{search.hotelGroupCode}
        ) t
        WHERE 1 = 1

        <!-- =========================
             검색 필터
             ========================= -->
        <if test="search.propertyCode != null">
            AND t.propertyCode = #{search.propertyCode}
        </if>

        <if test="search.reservationCode != null">
            AND t.reservationCode = #{search.reservationCode}
        </if>

        <if test="search.customerName != null and search.customerName != ''">
            AND t.customerNameHash LIKE CONCAT('%', #{search.customerName}, '%')
        </if>

        <if test="search.status != null and search.status != ''">
            AND t.operationStatus = #{search.status}
        </if>

        <if test="search.keyword != null and search.keyword != ''">
            AND (
            CAST(t.reservationCode AS CHAR) LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.customerNameHash LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.roomType LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.propertyName LIKE CONCAT('%', #{search.keyword}, '%')
            )
        </if>

        <!-- =========================
             ORDER BY
             ========================= -->
        ORDER BY
        <choose>
            <when test="sort != null and sort.sortBy == 't.operationStatus'">
                CASE
                WHEN t.operationStatus = 'CANCELED'  THEN 1
                WHEN t.operationStatus = 'NO_SHOW'   THEN 2
                WHEN t.operationStatus = 'RESERVED'  THEN 3
                WHEN t.operationStatus = 'STAYING'   THEN 4
                WHEN t.operationStatus = 'COMPLETED' THEN 5
                ELSE 6
                END ${sort.direction},
                t.plannedCheckinDate DESC,
                t.reservationCode DESC
            </when>

            <when test="sort != null and sort.sortBy != null">
                ${sort.sortBy} ${sort.direction},
                t.reservationCode DESC
            </when>

            <otherwise>
                t.plannedCheckinDate DESC,
                t.reservationCode DESC
            </otherwise>
        </choose>

        LIMIT #{page.size}
        OFFSET #{page.offset}
    </select>

    <!-- ================================================= -->
    <!-- 운영보드 조회 (COUNT) -->
    <!-- ================================================= -->
    <select id="countOperationBoard" resultType="long">
        SELECT COUNT(*)
        FROM (
        SELECT
        r.reservation_code AS reservationCode,
        r.property_code    AS propertyCode,
        c.customer_name_hash AS customerNameHash,
        r.checkin_date     AS plannedCheckinDate,
        r.checkout_date    AS plannedCheckoutDate,
        rt.type_name       AS roomType,
        p.property_name    AS propertyName,

        CASE
        -- 취소
        WHEN r.reservation_status = 'CANCELED'
        THEN 'CANCELED'

        -- 노쇼 (명시적)
        WHEN r.reservation_status = 'NO_SHOW'
        THEN 'NO_SHOW'

        -- 노쇼 (예약기간 지남 + 투숙 없음)
        WHEN r.checkout_date <![CDATA[ < ]]> CURRENT_DATE
        AND s.stay_code IS NULL
        THEN 'NO_SHOW'

        -- 예약 완료 (아직 체크인 전)
        WHEN s.stay_code IS NULL
        THEN 'RESERVED'

        -- 투숙 중
        WHEN s.actual_checkin_at IS NOT NULL
        AND s.actual_checkout_at IS NULL
        THEN 'STAYING'

        -- 정상 완료
        WHEN s.actual_checkin_at IS NOT NULL
        AND s.actual_checkout_at IS NOT NULL
        THEN 'COMPLETED'

        ELSE 'UNKNOWN'
        END AS operationStatus

        FROM reservation r
        INNER JOIN property p ON r.property_code = p.property_code
        INNER JOIN customer c ON r.customer_code = c.customer_code
        LEFT JOIN stay s ON r.reservation_code = s.reservation_code
        LEFT JOIN room ro ON r.room_code = ro.room_code
        LEFT JOIN room_type rt ON ro.room_type_code = rt.room_type_code
        WHERE p.hotel_group_code = #{search.hotelGroupCode}
        ) t
        WHERE 1 = 1

        <if test="search.propertyCode != null">
            AND t.propertyCode = #{search.propertyCode}
        </if>

        <if test="search.reservationCode != null">
            AND t.reservationCode = #{search.reservationCode}
        </if>

        <if test="search.customerName != null and search.customerName != ''">
            AND t.customerNameHash LIKE CONCAT('%', #{search.customerName}, '%')
        </if>

        <if test="search.status != null and search.status != ''">
            AND t.operationStatus = #{search.status}
        </if>

        <if test="search.keyword != null and search.keyword != ''">
            AND (
            CAST(t.reservationCode AS CHAR) LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.customerNameHash LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.roomType LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.propertyName LIKE CONCAT('%', #{search.keyword}, '%')
            )
        </if>
    </select>

</mapper>
