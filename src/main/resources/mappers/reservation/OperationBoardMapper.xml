<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gaekdam.gaekdambe.reservation_service.reservation.query.mapper.OperationBoardMapper">

    <!-- ========================= -->
    <!-- LIST -->
    <!-- ========================= -->
    <select id="findOperationBoard"
            resultType="com.gaekdam.gaekdambe.reservation_service.reservation.query.dto.response.OperationBoardCryptoRow">

        SELECT
        t.reservationCode,
        t.customerCode,
        t.customerNameEnc,
        t.dekEnc,
        t.roomType,
        t.propertyName,
        t.plannedCheckinDate,
        t.plannedCheckoutDate,
        t.operationStatus
        FROM (
        SELECT
        r.reservation_code AS reservationCode,
        c.customer_code    AS customerCode,
        c.customer_name_enc AS customerNameEnc,
        c.customer_name_hash AS customerNameHash,
        c.dek_enc          AS dekEnc,
        rt.type_name       AS roomType,
        p.property_name    AS propertyName,
        r.checkin_date     AS plannedCheckinDate,
        r.checkout_date    AS plannedCheckoutDate,
        r.property_code    AS propertyCode,

        CASE
        WHEN r.reservation_status = 'CANCELED' THEN 'CANCELED'
        WHEN r.reservation_status = 'NO_SHOW' THEN 'NO_SHOW'
        WHEN s.stay_code IS NULL THEN 'RESERVED'
        WHEN s.actual_checkin_at IS NOT NULL
        AND s.actual_checkout_at IS NULL THEN 'STAYING'
        WHEN s.actual_checkin_at IS NOT NULL
        AND s.actual_checkout_at IS NOT NULL THEN 'COMPLETED'
        ELSE 'UNKNOWN'
        END AS operationStatus

        FROM reservation r
        INNER JOIN property p ON r.property_code = p.property_code
        INNER JOIN customer c ON r.customer_code = c.customer_code
        LEFT JOIN stay s ON r.reservation_code = s.reservation_code
        LEFT JOIN room ro ON r.room_code = ro.room_code
        LEFT JOIN room_type rt ON ro.room_type_code = rt.room_type_code
        WHERE p.hotel_group_code = #{search.hotelGroupCode}
        ) t
        WHERE 1 = 1

        <if test="search.propertyCode != null">
            AND t.propertyCode = #{search.propertyCode}
        </if>

        <if test="search.reservationCode != null">
            AND
            CAST(t.reservationCode AS CHAR) LIKE CONCAT('%', #{search.reservationCode}, '%')
        </if>

        <if test="search.customerNameHash != null">
            AND t.customerNameHash = #{search.customerNameHash}
        </if>

        <if test="search.status != null and search.status != ''">
            AND t.operationStatus = #{search.status}
        </if>

        <!-- 전체검색 (고객명 제외) -->
        <if test="search.keyword != null and search.keyword != ''">
            AND (
            CAST(t.reservationCode AS CHAR) LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.roomType LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.propertyName LIKE CONCAT('%', #{search.keyword}, '%')
            )
        </if>

        ORDER BY
        ${sort.sortBy} ${sort.direction}
        LIMIT #{page.size}
        OFFSET #{page.offset}
    </select>

    <!-- ========================= -->
    <!-- COUNT -->
    <!-- ========================= -->
    <select id="countOperationBoard" resultType="long">

        SELECT COUNT(*)
        FROM (
        SELECT
        r.reservation_code AS reservationCode,
        r.property_code    AS propertyCode,
        c.customer_name_hash AS customerNameHash,
        rt.type_name       AS roomType,
        p.property_name    AS propertyName,

        CASE
        WHEN r.reservation_status = 'CANCELED' THEN 'CANCELED'
        WHEN r.reservation_status = 'NO_SHOW' THEN 'NO_SHOW'
        WHEN s.stay_code IS NULL THEN 'RESERVED'
        WHEN s.actual_checkin_at IS NOT NULL
        AND s.actual_checkout_at IS NULL THEN 'STAYING'
        WHEN s.actual_checkin_at IS NOT NULL
        AND s.actual_checkout_at IS NOT NULL THEN 'COMPLETED'
        ELSE 'UNKNOWN'
        END AS operationStatus

        FROM reservation r
        INNER JOIN property p ON r.property_code = p.property_code
        INNER JOIN customer c ON r.customer_code = c.customer_code
        LEFT JOIN stay s ON r.reservation_code = s.reservation_code
        LEFT JOIN room ro ON r.room_code = ro.room_code
        LEFT JOIN room_type rt ON ro.room_type_code = rt.room_type_code
        WHERE p.hotel_group_code = #{search.hotelGroupCode}
        ) t
        WHERE 1 = 1

        <if test="search.propertyCode != null">
            AND t.propertyCode = #{search.propertyCode}
        </if>

        <if test="search.reservationCode != null">
            AND
            CAST(t.reservationCode AS CHAR) LIKE CONCAT('%', #{search.reservationCode}, '%')
        </if>

        <if test="search.customerNameHash != null">
            AND t.customerNameHash = #{search.customerNameHash}
        </if>

        <if test="search.status != null and search.status != ''">
            AND t.operationStatus = #{search.status}
        </if>

        <if test="search.keyword != null and search.keyword != ''">
            AND (
            CAST(t.reservationCode AS CHAR) LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.roomType LIKE CONCAT('%', #{search.keyword}, '%')
            OR t.propertyName LIKE CONCAT('%', #{search.keyword}, '%')
            )
        </if>

    </select>

</mapper>
