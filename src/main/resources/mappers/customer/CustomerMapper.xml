<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gaekdam.gaekdambe.customer_service.customer.query.mapper.CustomerMapper">

    <sql id="BaseFrom">
        FROM customer c

        <!-- 대표 연락처 1개: is_primary 우선, PHONE 우선 -->
        LEFT JOIN (
        SELECT *
        FROM (
        SELECT
        cc.*,
        ROW_NUMBER() OVER (
        PARTITION BY cc.customer_code
        ORDER BY
        cc.is_primary DESC,
        CASE WHEN cc.contact_type = 'PHONE' THEN 1 ELSE 0 END DESC,
        cc.updated_at DESC,
        cc.contact_code DESC
        ) AS rn
        FROM customer_contact cc
        ) t
        WHERE t.rn = 1
        ) pc
        ON pc.customer_code = c.customer_code

        <!-- 멤버십: (customer_code, hotel_group_code) 기준 ACTIVE 최신 1건 -->
        LEFT JOIN (
        SELECT *
        FROM (
        SELECT
        m.*,
        ROW_NUMBER() OVER (
        PARTITION BY m.customer_code, m.hotel_group_code
        ORDER BY m.updated_at DESC, m.membership_code DESC
        ) AS rn
        FROM membership m
        WHERE m.membership_status = 'ACTIVE'
        AND m.hotel_group_code = #{hotelGroupCode}
        ) t
        WHERE t.rn = 1
        ) m
        ON m.customer_code = c.customer_code
        AND m.hotel_group_code = c.hotel_group_code

        LEFT JOIN membership_grade mg
        ON mg.membership_grade_code = m.membership_grade_code
        AND mg.hotel_group_code = c.hotel_group_code

        <!-- 로열티: (customer_code, hotel_group_code) 기준 ACTIVE 최신 1건 -->
        LEFT JOIN (
        SELECT *
        FROM (
        SELECT
        l.*,
        ROW_NUMBER() OVER (
        PARTITION BY l.customer_code, l.hotel_group_code
        ORDER BY l.updated_at DESC, l.loyalty_code DESC
        ) AS rn
        FROM loyalty l
        WHERE l.loyalty_status = 'ACTIVE'
        AND l.hotel_group_code = #{hotelGroupCode}
        ) t
        WHERE t.rn = 1
        ) l
        ON l.customer_code = c.customer_code
        AND l.hotel_group_code = c.hotel_group_code
    </sql>

    <sql id="BaseWhere">
        WHERE c.hotel_group_code = #{hotelGroupCode}

        <if test="status != null">
            AND c.customer_status = #{status}
        </if>

        <if test="contractType != null">
            AND c.contract_type = #{contractType}
        </if>

        <if test="nationalityType != null">
            AND c.nationality_type = #{nationalityType}
        </if>

        <if test="membershipGradeName != null">
            AND mg.grade_name = #{membershipGradeName}
        </if>

        <if test="loyaltyGradeCode != null">
            AND l.loyalty_grade_code = #{loyaltyGradeCode}
        </if>

        <!-- 고객코드 exact -->
        <if test="customerCode != null">
            AND c.customer_code = #{customerCode}
        </if>

        <if test="customerNameHash != null">
            AND c.customer_name_hash = #{customerNameHash}
        </if>

        <if test="contactValueHash != null">
            AND EXISTS (
            SELECT 1
            FROM customer_contact cx
            WHERE cx.customer_code = c.customer_code
            AND cx.contact_value_hash = #{contactValueHash}
            )
        </if>
    </sql>

    <select id="countCustomerUnifiedList"
            parameterType="com.gaekdam.gaekdambe.customer_service.customer.query.service.model.CustomerUnifiedListCondition"
            resultType="long">
        SELECT COUNT(*)
        FROM (
        SELECT c.customer_code
        <include refid="BaseFrom"/>
        <include refid="BaseWhere"/>
        GROUP BY c.customer_code
        ) x
    </select>

    <select id="findCustomerUnifiedList"
            parameterType="com.gaekdam.gaekdambe.customer_service.customer.query.service.model.CustomerUnifiedListCondition"
            resultType="com.gaekdam.gaekdambe.customer_service.customer.query.service.model.CustomerUnifiedRow">
        SELECT
        c.customer_code       AS customerCode,
        c.customer_name_enc   AS customerNameEnc,
        pc.contact_value_enc  AS primaryContactValueEnc,

        c.customer_status     AS customerStatus,
        c.contract_type       AS contractType,
        c.nationality_type    AS nationalityType,

        mg.grade_name         AS membershipGradeName,
        l.loyalty_grade_code  AS loyaltyGradeCode

        <include refid="BaseFrom"/>
        <include refid="BaseWhere"/>

        ORDER BY c.created_at DESC, c.customer_code DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

</mapper>
